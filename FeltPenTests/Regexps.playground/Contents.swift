import UIKit

//#-hidden-code
func parse(string: String, regex: NSRegularExpression) -> NSAttributedString {
    let matches = regex.matches(in: string, options: [], range: NSRange(location: 0, length: string.characters.count))
    
    let attrString = NSMutableAttributedString.init(string: "\(string)",
        attributes: [ NSAttributedStringKey.backgroundColor : #colorLiteral(red: 0.9254902005, green: 0.6173418388, blue: 0.5980237226, alpha: 1)])
    for match in matches {
        attrString.setAttributes([NSAttributedStringKey.backgroundColor: UIColor.green], range: match.range)
    }
    attrString.insert(.init(string: "\(matches.count): \t", attributes: nil), at: 0)
    return attrString
}

let text = NSMutableAttributedString.init(string: "text", attributes: [
    NSAttributedStringKey.baselineOffset : 1.5,
    NSAttributedStringKey.strikethroughStyle : NSUnderlineStyle.styleNone.rawValue
    ])
let textRange = NSRange.init(location: 0, length: text.length)
let attributes : [NSAttributedStringKey : Any] = [
    NSAttributedStringKey.strikethroughStyle : NSNumber.init(value: NSUnderlineStyle.patternDashDot.rawValue),
    NSAttributedStringKey.strikethroughColor : UIColor.green,
    NSAttributedStringKey.font : UIFont.systemFont(ofSize: 20.0),
    NSAttributedStringKey.foregroundColor : UIColor.darkGray,
    NSAttributedStringKey.backgroundColor : UIColor.init(white: 0.9, alpha: 1.0)
]
text.addAttributes(attributes, range: textRange)

func parse(string: String, regexPattern: String) -> NSAttributedString {
    let result: NSAttributedString
    if let regex = try? NSRegularExpression.init(pattern: regexPattern, options: []) {
        result = parse(string: string, regex: regex)
    }
    else {
        result = NSAttributedString.init(string: "INVALID REGEX =(", attributes: [NSAttributedStringKey.backgroundColor : #colorLiteral(red: 0.9254902005, green: 0.6173418388, blue: 0.5980237226, alpha: 1),
                                                                                  NSAttributedStringKey.foregroundColor : #colorLiteral(red: 0, green: 0, blue: 0, alpha: 1)])
    }
    return result
}
//#-end-hidden-code

//: Change string/pattern here
//#-editable-code
let pattern = "(?<=(^|\\s)(_|\\*|`)\\*?)(_|\\*|`)"

let string = "      *_*`test`_"
//#-end-editable-code

let result = parse(string: string, regexPattern: pattern)
